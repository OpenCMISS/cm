\subsection{Poiseuille Flow Equations}

\subsubsection{Governing equations:}

The Poiseuille equation describes the pressure drop that occurs due to viscous friction from laminar fluid flow over a straight pipe. Poiseuille flow can be derived from the Navier-Stokes equationsin cylindrical coordinates by assuming that the flow is: (1) Steady ($\delby{(..)}{t}=0$) (2) The radial and swirl components of fluid velocity are zero ($u_{r}=u_{\theta}=0)$) (3) The flow is axisymmetric ($\delby{(..)}{\theta}=0$) and fully developed ($\delby{(u_{z})}{z}=0$).

The Poiseuille equation is:

\begin{equation}
\label{eqn:Poiseuille_equation}
 \grad{P}=\frac{8{\mu}}LQ}{\pi{R^{4}}}
\end{equation}
where \grad{P} is the pressure drop along the pipe, $\mu$ is the viscosity $L$ is the length of the pipe $Q$ is volumetric flow and $R$ is the radius of the pipe.

rearranging:
\begin{equation}
 Q=\frac{\pi{R^{2}}R^{2}\grad{P}}{8\mu{L}
\end{equation}

Volumetric flow is average axisymmetric flow ($\bar{u}$) multipled by the area of the pipe A ($Q=\bar{u}A$) and frac{$\grad{P}}{L}=\dfrac{P}{x}$
eqn:Poiseuille_equation
\begin{equation}
\bar{u}A=\frac{AR^{2}}{8\mu}\dfrac{P}{x}
\end{equation}

or 

\begin{equation}
 \frac{R^{2}}{8\mu}\dfrac{P}{x}-\bar{u}=0
\end{equation}



\subsubsection{Weak formulation:}

The weak form of the differential form of the Poiseuille equation system consisting of \eqnref{eqn:Poiseuille_equation} and can be written as:

\begin{equation}
  -\gint{\Omega}{}{\frac{R^{2}}{8\mu}\grad{p}{\omega}-\bar{u}{\omega}}{\Omega}
  \label{eqn:Poiseuilleweakform}
\end{equation}

or

\begin{equation}
  -\gint{\Omega}{}{\frac{R^{2}}{8\mu}\dfrac{p}{x}{\omega}-\bar{u}{\omega}}{\Omega}
  \label{eqn:Poiseuilleweakform2}
\end{equation}

The left-hand side of \eqnref{eqn:Poiseulleweakform2} represents the unknown velocity and pressure field on $\Omega$ 

\subsubsection{Finite element formulation:}
We can now discretise the domain into finite elements \eqnref{eqn:Poiseuilleweakform2} becomes

\begin{equation}
  \dsum_{e=1}^{E}\gint{\Omega_{e}}{}{\frac{R^{2}}{r\mu}\dfrac{P}{x}{\omega}-\bar{u}{\omega}}{\Omega}
  =\gint{0}{1}{\frac{R^{2}}{8\mu}\dfrac{P{\xi}{\xi}\dfrac{xi}{x}{\omega}-\bar{u}{\omega}|J(\xi)|}{\xi}
\end{equation}

The next dependent variable, $u$,is approximated using basis
functions. 

Using a Galerkin finite element approach (where the weighting functions are
chosento be the interpolating basis functions) we have 
\begin{equation}
  \fnof{w}{\vect{\xi}}=\gbfn{m}{\alpha}{\vect{\xi}}\gsf{m}{\alpha}
\end{equation}

\subsubsection{Spatial integration:}

When dealing with integrals a similar interpolation notation is adopted in
that $d\vect{\xi}$ is the appropriate infinitesimal for the dimension of the
problem. The limits of the integral are also written in bold font and indicate
the appropriate number of integrals for the dimension of the problem.  For
example if $\vect{\xi}=\bbrac{\xione,\xitwo}$ then
$\gint{\vect{0}}{\vect{1}}{x}
{\vect{\xi}}=\giint{0}{1}{0}{1}{x}{\xione}{\xitwo}$,
but if $\vect{\xi}=\bbrac{\xione,\xitwo,\xithree}$ then 
$\gint{\vect{0}}{\vect{1}}{x}{\vect{\xi}}=
\dintl{0}{1}\!\dintl{0}{1}\!\dintl{0}{1}\,x\,d\xione d\xitwo d\xithree$.

In order to integrate in $\vect{\xi}$ coordinates we must convert the spatial
derivatives to derivatives with respect to $\vect{\xi}$. Using the tensor
transformation equations for a covariant vector we have
\begin{equation}  
  \covarderiv{u}{i}=\delby{\xi^{s}}{x^{i}}\covarderiv{u}{s}=
  \delby{\xi^{s}}{x^{i}}\delby{u}{\xi^{s}}
\end{equation}
and 
\begin{equation}
  \covarderiv{w}{k}=\delby{\xi^{r}}{x^{k}}\covarderiv{w}{r}=
  \delby{\xi^{r}}{x^{k}}\delby{w}{\xi^{r}}
\end{equation}

As we only know $\tilde{\tensor{\sigma}}$, the conductivity in the 
$\vect{\nu}$ (fibre) coordinate system rather than $\tensor{\sigma}$, the
conductivity in the $\vect{x}$ (geometric) coordinate system, we must transform the mixed
tensor ${\tilde{\sigma}}^{a}_{.b}$ from $\vect{\nu}$ to $\vect{x}$ coordinates. However, as the
fibre coordinate system is defined in terms of $\vect{\xi}$ coordinates we
first transform the conductivity tensor from $\vect{\nu}$ to $\vect{\xi}$
coordinates \ie
\begin{equation}
  \fnof{\sigma^{d}_{.e}}{\vect{\xi}}=\delby{\xi^{d}}{\nu^{a}}\delby{\nu^{b}}{\xi^{e}}
  \fnof{{\tilde{\sigma}}^{a}_{.b}}{\vect{\xi}}
\end{equation}
with $.b$ indicating that $b$ is the ``second'' index (\secref{subsec:summation notation}),
and then transform the conductivity from $\vect{\xi}$ coordinates to
$\vect{x}$ coordinates \ie
\begin{equation}
  \begin{split}
    \fnof{\sigma^{i}_{.j}}{\vect{\xi}} &=
    \delby{x^{i}}{\xi^{d}}\delby{\xi^{e}}{x^{j}}
    \fnof{{\sigma}^{d}_{.e}}{\vect{\xi}} \\
    &= \delby{x^{i}}{\xi^{d}}\delby{\xi^{e}}{x^{j}}\delby{\xi^{d}} 
    {\nu^{a}}\delby{\nu^{b}}{\xi^{e}}\fnof{{\tilde{\sigma}}^{a}_{.b}}{\vect{\xi}}
  \end{split}
\end{equation}
where $\tilde{\tensor{\sigma}}$ is interpolated in the normal way \ie
\begin{equation}
  \fnof{\tilde{\tensor{\sigma}}}{\vect{\xi}}
  =\gbfn{p}{\delta}{\vect{\xi}}\nodedof{\tilde{\tensor{\sigma}}}{p}{\delta}
  \gsf{p}{\delta}
\end{equation}

Using an interpolated variables yields
\begin{multline}
  \dsum_{e=1}^{E}\dintl{\vect{0}}{\vect{1}}G^{jk}\delby{x^{i}}{\xi^{d}}
    \delby{\xi^{e}}{x^{j}}\delby{\xi^{d}}{\nu^{a}}
    \delby{\nu^{b}}{\xi^{e}}\fnof{{\tilde{\sigma}}^{a}_{.b}}{\vect{\xi}}\delby{\xi^{s}}{x^{i}} \\
    \delby{\pbrac{\gbfn{n}{\beta}{\vect{\xi}}\nodedof{u}{n}{\beta}\gsf{n}{\beta}}}{\xi^{s}}
    \delby{\xi^{r}}{x^{k}}\delby{\pbrac{\gbfn{m}{\alpha}{\vect{\xi}}\gsf{m}{\alpha}}}{\xi^{r}}
    \abs{\fnof{\matr{J}}{\vect{\xi}}}d\vect{\xi} \\ 
  = \dsum_{f=1}^{F}\gint{\Gamma_{f}}{}{\gbfn{o}{\gamma}{\vect{\xi}}\nodedof{q}{o}{\gamma}
    \gsf{o}{\gamma}\gbfn{m}{\alpha}{\vect{\xi}}\gsf{m}{\alpha}}{\Gamma}
\end{multline}
where $\fnof{\matr{J}}{\vect{\xi}}$ is the \emph{Jacobian} of the
transformation from the integration $\vect{x}$ to $\vect{\xi}$ coordinates.

Taking the fixed nodal degrees-of-freedom and scale factors outside the integral we have
\begin{multline}
  \dsum_{e=1}^{E}\nodedof{u}{n}{\beta}\gsf{m}{\alpha}\gsf{n}{\beta}
  \dintl{\vect{0}}{\vect{1}}G^{jk}\delby{x^{i}}{\xi^{d}}
  \delby{\xi^{e}}{x^{j}}\delby{\xi^{d}}{\nu^{a}}
  \delby{\nu^{b}}{\xi^{e}}\fnof{{\tilde{\sigma}}^{a}_{.b}}{\vect{\xi}} \\
  \delby{\xi^{r}}{x^{i}}\delby{\xi^{s}}{x^{k}}
  \delby{\gbfn{m}{\alpha}{\vect{\xi}}}{\xi^{s}}
  \delby{\gbfn{n}{\beta}{\vect{\xi}}}{\xi^{r}}
  \abs{\fnof{\matr{J}}{\vect{\xi}}}d\vect{\xi} \\
  = \dsum_{f=1}^{F}\nodedof{q}{o}{\gamma}\gsf{m}{\alpha}\gsf{o}{\gamma}
  \gint{\Gamma_{f}}{}{\gbfn{o}{\gamma}{\vect{\xi}}\gbfn{m}{\alpha}{\vect{\xi}}}{\Gamma}
  \label{eqn:elementalfemlhs1}
\end{multline}

This is an equation of the form of
\begin{equation}
  \matr{K}\vect{u}=\vect{f}
\end{equation}
where
\begin{equation}
  \vect{f}=\matr{N}\vect{q}
\end{equation}

The elemental stiffness matrix, $K^{\alpha\beta}_{mn}$, is given by
\begin{equation}
  K^{\alpha\beta}_{mn}=\gsf{m}{\alpha}\gsf{m}{\beta}
  \gint{\vect{0}}{\vect{1}}{\delby{\gbfn{m}{\alpha}{\vect{\xi}}}{\xi^{r}}
    \delby{\gbfn{n}{\beta}{\vect{\xi}}}{\xi^{s}}\fnof{\gamma^{rs}}{\vect{\xi}}
    \abs{\fnof{\matr{J}}{\vect{\xi}}}}{\vect{\xi}}
  \label{eqn:elementalfemlhs2}
\end{equation}
where
\begin{equation}
  \fnof{\gamma^{rs}}{\vect{\xi}}=G^{jk}\delby{x^{i}}{\xi^{d}}
  \delby{\xi^{e}}{x^{j}}\delby{\xi^{d}}{\nu^{a}}\delby{\nu^{b}}{\xi^{e}}
  \fnof{{\tilde{\sigma}}^{a}_{.b}}{\vect{\xi}}\delby{\xi^{r}}{x^{i}}\delby{\xi^{s}}{x^{k}}
  \label{eqn:diffusiongammadefinition1}
\end{equation}

Note that for Laplace's equation with no conductivity or fibre fields we have
\begin{equation}
  \fnof{\gamma^{rs}}{\vect{\xi}}=G^{ik}\delby{\xi^{r}}{x^{i}}\delby{\xi^{s}}{x^{k}}
  \label{eqn:diffusiongammadefinition2}
\end{equation}
and that for rectangular-Cartesian coordinates systems
$G^{ik}=\contrakronecker{i}{k}$ and thus $i=k$. This now gives
\begin{equation}
  \fnof{\gamma^{rs}}{\vect{\xi}}=\delby{\xi^{r}}{x^{i}}\delby{\xi^{s}}{x^{i}}=g^{rs}
  \label{eqn:diffusiongammadefinition3}
\end{equation}
where $g^{rs}$ is the \emph{contravariant metric tensor} from $\vect{x}$ to
$\vect{\xi}$ coordinates. It may thus be helpful to think about $\gamma^{rs}$
as a scaled/transformed contravariant metric tensor.

The right hand side flux matrix, $N^{\alpha\gamma}_{mo}$, is given by
\begin{equation}
  N^{\alpha\gamma}_{mo} = \gsf{m}{\alpha}\gsf{o}{\gamma}
  \gint{\Gamma_{f}}{}{\gbfn{m}{\alpha}{\vect{\xi}}\gbfn{o}{\gamma}{\vect{\xi}}}{\Gamma}
\end{equation}

% \subsubsection{Coded OpenCMISS formulation:}
% Finally, we use the Gaussian quadrature rule (see Section~??? - still to be written), 
% usually stated as a weighted sum of function values at specified Gauss points within the domain of integration. An $n$-point Gaussian quadrature rule yields an exact result for polynomials of degree $2n-1$ or less by a suitable choice of the points $x_i$ and weights $g_i$ for $i = 1,...,n$. Consequently, the formulation implemented can be derived from Equation (\ref{eqn:elementalfemlhs2}) as: 
% \begin{equation}
%   \boxed{
%   \dsum_{e=1}^{E}\nodedof{\phi}{\alpha}{u}\gsf{(\alpha)}{(u)} \gsf{(\beta)}{(v)}
%   \dsum_{i=1}^{n}
%   \left(\delby{\gbfn{\alpha}{u}{\vect{\xi}}}{\xi^{r}}
%   \delby{\gbfn{\beta}{v}{\vect{\xi}}}{\xi^{s}}\gamma^{rs}\abs{\fnof{\matr{J}}{\vect{\xi}}}
%   \right)(x_i)g_i
%   }
%   \label{eqn:Laplaceweightedresidualtensorform in OpenCMISS}
% \end{equation}


% \newpage
% \subsubsection{OpenCMISS implementation}

% For exemplification, we briefly discuss here a code snippet
% that evaluates the expression~(\ref{eqn:Laplaceweightedresidualtensorform in OpenCMISS}):

% \lstset{ %
% language=Fortran,               % choose the language of the code
% basicstyle=\footnotesize,       % the size of the fonts that are used for the code
% numbers=left,                   % where to put the line-numbers
% numberstyle=\footnotesize,      % the size of the fonts that are used for the line-numbers
% stepnumber=1,                   % the step between two line-numbers. If it's 1 each line 
%                                 % will be numbered
% numbersep=5pt,                  % how far the line-numbers are from the code
% backgroundcolor=\color{white},  % choose the background color. You must add \usepackage{color}
% showspaces=false,               % show spaces adding particular underscores
% showstringspaces=false,         % underline spaces within strings
% showtabs=false,                 % show tabs within strings adding particular underscores
% frame=single,	                % adds a frame around the code
% tabsize=2,	                % sets default tabsize to 2 spaces
% captionpos=b,                   % sets the caption-position to bottom
% breaklines=true,                % sets automatic line breaking
% breakatwhitespace=false,        % sets if automatic breaks should only happen at whitespace
% title=\lstname,                 % show the filename of files included with \lstinputlisting;
%                                 % also try caption instead of title
% escapeinside={\%*}{*)},         % if you want to add a comment within your code
% morekeywords={*,...}            % if you want to add more keywords to the set
% }




% {\footnotesize\tt
% \begin{lstlisting}
% SUBROUTINE LAPLACE_EQUATION_FINITE_ELEMENT_CALCULATE(EQUATIONS_SET,ELEMENT_NUMBER, ERR,ERROR,*)
%   DO ng=1,QUADRATURE_SCHEME%NUMBER_OF_GAUSS
%     RWG=EQUATIONS%INTERPOLATION%GEOMETRIC_INTERP_POINT_METRICS(FIELD_U_VARIABLE_TYPE)%PTR%JACOBIAN*QUADRATURE_SCHEME%GAUSS_WEIGHTS(ng)
%     mhs=0          
%     !Loop over element rows
%     DO mh=1,FIELD_VARIABLE%NUMBER_OF_COMPONENTS
%       DO ms=1,DEPENDENT_BASIS%NUMBER_OF_ELEMENT_PARAMETERS
%         mhs=mhs+1
%         nhs=0
%         IF(EQUATIONS_MATRIX%UPDATE_MATRIX) THEN
%           !Loop over element columns
%           DO nh=1,FIELD_VARIABLE%NUMBER_OF_COMPONENTS
%             DO ns=1,DEPENDENT_BASIS%NUMBER_OF_ELEMENT_PARAMETERS
%               nhs=nhs+1
%               DO ni=1,DEPENDENT_BASIS%NUMBER_OF_XI
%                 PGMSI(ni)=QUADRATURE_SCHEME%GAUSS_BASIS_FNS(ms,PARTIAL_DERIVATIVE_FIRST_DERIVATIVE_MAP(ni),ng)
%                 PGNSI(ni)=QUADRATURE_SCHEME%GAUSS_BASIS_FNS(ns,PARTIAL_DERIVATIVE_FIRST_DERIVATIVE_MAP(ni),ng)
%               ENDDO !ni
%               SUM=0.0_DP
%               DO mi=1,DEPENDENT_BASIS%NUMBER_OF_XI
%                 DO ni=1,DEPENDENT_BASIS%NUMBER_OF_XI
%                   SUM=SUM+PGMSI(mi)*PGNSI(ni)*EQUATIONS%INTERPOLATION% &
%                     & GEOMETRIC_INTERP_POINT_METRICS(FIELD_U_VARIABLE_TYPE)%PTR%GU(mi,ni)
%                 ENDDO !ni
%               ENDDO !mi
%               EQUATIONS_MATRIX%ELEMENT_MATRIX%MATRIX(mhs,nhs)=EQUATIONS_MATRIX%ELEMENT_MATRIX%MATRIX(mhs,nhs)+SUM*RWG
%             ENDDO !ns
%           ENDDO !nh
%         ENDIF
%       ENDDO !ms
%     ENDDO !mh
%   ENDDO !ng
% \end{lstlisting}
% }


% % * Still explain that we loop over the rows of the element matrix,
% %   and the loop is composed of a loop over number of components and element parameters.

% \begin{tabular}{|rp{0.9\textwidth}|}
%   \hline
%   Line & Explanation \\
%   & \\
%   2 & Loop over the number of Gauss points\\
%   3 & Weight factor = Jacobian of the mapping * quadrature weight\\
%   6 & Loop ({\bf rows}) over the number of variable components 
%       (For the scalar case of Laplace, this number is 1 (scalar potential),
%       whereas for a system like 3D incompressible Navier-Stokes, 
%       this number is 4 (3 velocity components and pressure))\\
%   7 & Loop ({\bf rows}) over the number of element parameters (= the number of interpolation functions 
%       associated with this element) \\
%   12 & Loop ({\bf columns}) over the number of variable components\\ 
%   13 & Loop ({\bf columns}) over the number of element parameters\\
%   15 & Loop over the element $\xi$-directions\\
%   20 & Loop over the element $\xi$-directions\\
%   21 & Loop over the element $\xi$-directions\\
%   26 & Add contribution to element matrix entry {\tt (mhs,nhs)}\\
%   \hline
% \end{tabular}








\subsubsection{Finite element formulation:}

We can now discretise the domain into finite elements \ie $\Omega=
\displaystyle{\bigcup_{e=1}^{E}}\Omega_{e}$ with
$\Gamma=\displaystyle{\bigcup_{f=1}^{F}}\Gamma_{f}$, 
\eqnref{eqn:Laplaceweightedresidualtensorform2} becomes
\begin{equation}
  \dsum_{e=1}^{E}\gint{\Omega_{e}}{}{G^{jk}\sigma^{i}_{j}\covarderiv{u}{i}\covarderiv{w}{k}}{\Omega}
  =\dsum_{f=1}^{F}\gint{\Gamma_{f}}{}{qw}{\Omega}
\end{equation}

The next step is to approximate the dependent variable, $u$, using basis
functions. To simplify this for different types of basis functions an
\emph{interpolation notation} is adopted. This interpolation is such that
$\gbfn{n}{\beta}{\vect{\xi}}$ are the appropriate basis functions for the
type of element (\eg \bicubicherm, Hermite-sector, \etc) and dimension of 
the problem (one, two or \threedal). For example if $\vect{\xi}=\bbrac{\xi}$ 
and the element is a cubic Hermite element
(\secref{sec:Hermitianbasisfunctions}) then $\gbfn{n}{\beta}{\vect{\xi}}$ 
are the cubic Hermite basis functions where the local node number $n$ ranges 
from $1$ to $2$ and the derivative $\beta$ ranges from $0$ to $1$. If,
however, $\vect{\xi}=\bbrac{\xione,\xitwo}$ and the element is a \bicubicherm 
element then $n$ ranges from $1$ to $4$, $\beta$ ranges from $0$ to $3$ and
$\gbfn{n}{\beta}{\vect{\xi}}$ is the appropriate basis function for the nodal
variable $\nodedof{u}{n}{\beta}$. The nodal variables are defined as
follows: $\nodedof{u}{n}{0}=\nodept{u}{n}$,
$\nodedof{u}{n}{1}=\delby{\nodept{u}{n}}{s_{1}}$,
$\nodedof{u}{n}{2}=\delby{\nodept{u}{n}}{s_{2}}$,
$\nodedof{u}{n}{3}=\deltwoby{\nodept{u}{n}}{s_{1}}{s_{2}}$,
\etc Hence for the \bicubicherm element the interpolation function
$\gbfn{2}{3}{\vect{\xi}}$ multiplies the nodal variable
$\nodedof{u}{2}{3}=\deltwoby{u^{2}}{s_{1}}{s_{2}}$ and thus the
interpolation function is $\chbfn{2}{1}{\xione}\chbfn{1}{1}{\xitwo}$.  The
scale factors for the Hermite interpolation are handled by the introduction of
an interpolation scale factor $\gsf{n}{\beta}$ defined as follows:
$\gsf{n}{0}=1$, $\gsf{n}{1}=\nsftwo{n}{1}$, $\gsf{n}{2}=
\nsftwo{n}{2}$, $\gsf{n}{3}=\nsftwo{n}{1}\nsftwo{n}{2}$,
\etc For Lagrangian basis functions the interpolation scale factors are all
one. The general form of the interpolation notation for $u$ is then
\begin{equation}
  \fnof{u}{\vect{\xi}}=\gbfn{n}{\beta}{\vect{\xi}}\nodedof{u}{n}{\beta}\gsf{n}{\beta}
  \label{eqn:uinterpolation}
\end{equation}

We can also interpolate the other variables in a similar manner \ie
\begin{equation}
  \begin{split}
    \fnof{q}{\vect{\xi}} &= \gbfn{o}{\gamma}{\vect{\xi}\nodedof{q}{o}{\gamma}}
    \gsf{o}{\gamma} \\
    \fnof{\tensor{\sigma}}{\vect{\xi}}
    &=\gbfn{p}{\delta}{\vect{\xi}}\nodedof{\tensor{\sigma}}{p}{\delta}\gsf{p}{\delta} \\
  \end{split}
\end{equation}
where $\nodedof{q}{o}{\gamma}$ and $\nodedof{\tensor{\sigma}}{p}{\delta}$ are the
nodal degrees-of-freedom for the flux variable and conductivity tensor.

Using a Galerkin finite element approach (where the weighting functions are
chosento be the interpolating basis functions) we have 
\begin{equation}
  \fnof{w}{\vect{\xi}}=\gbfn{m}{\alpha}{\vect{\xi}}\gsf{m}{\alpha}
\end{equation}

\subsubsection{Spatial integration:}

When dealing with integrals a similar interpolation notation is adopted in
that $d\vect{\xi}$ is the appropriate infinitesimal for the dimension of the
problem. The limits of the integral are also written in bold font and indicate
the appropriate number of integrals for the dimension of the problem.  For
example if $\vect{\xi}=\bbrac{\xione,\xitwo}$ then
$\gint{\vect{0}}{\vect{1}}{x}
{\vect{\xi}}=\giint{0}{1}{0}{1}{x}{\xione}{\xitwo}$,
but if $\vect{\xi}=\bbrac{\xione,\xitwo,\xithree}$ then 
$\gint{\vect{0}}{\vect{1}}{x}{\vect{\xi}}=
\dintl{0}{1}\!\dintl{0}{1}\!\dintl{0}{1}\,x\,d\xione d\xitwo d\xithree$.

In order to integrate in $\vect{\xi}$ coordinates we must convert the spatial
derivatives to derivatives with respect to $\vect{\xi}$. Using the tensor
transformation equations for a covariant vector we have
\begin{equation}  
  \covarderiv{u}{i}=\delby{\xi^{s}}{x^{i}}\covarderiv{u}{s}=
  \delby{\xi^{s}}{x^{i}}\delby{u}{\xi^{s}}
\end{equation}
and 
\begin{equation}
  \covarderiv{w}{k}=\delby{\xi^{r}}{x^{k}}\covarderiv{w}{r}=
  \delby{\xi^{r}}{x^{k}}\delby{w}{\xi^{r}}
\end{equation}

As we only know $\tilde{\tensor{\sigma}}$, the conductivity in the 
$\vect{\nu}$ (fibre) coordinate system rather than $\tensor{\sigma}$, the
conductivity in the $\vect{x}$ (geometric) coordinate system, we must transform the mixed
tensor ${\tilde{\sigma}}^{a}_{.b}$ from $\vect{\nu}$ to $\vect{x}$ coordinates. However, as the
fibre coordinate system is defined in terms of $\vect{\xi}$ coordinates we
first transform the conductivity tensor from $\vect{\nu}$ to $\vect{\xi}$
coordinates \ie
\begin{equation}
  \fnof{\sigma^{d}_{.e}}{\vect{\xi}}=\delby{\xi^{d}}{\nu^{a}}\delby{\nu^{b}}{\xi^{e}}
  \fnof{{\tilde{\sigma}}^{a}_{.b}}{\vect{\xi}}
\end{equation}
with $.b$ indicating that $b$ is the ``second'' index (\secref{subsec:summation notation}),
and then transform the conductivity from $\vect{\xi}$ coordinates to
$\vect{x}$ coordinates \ie
\begin{equation}
  \begin{split}
    \fnof{\sigma^{i}_{.j}}{\vect{\xi}} &=
    \delby{x^{i}}{\xi^{d}}\delby{\xi^{e}}{x^{j}}
    \fnof{{\sigma}^{d}_{.e}}{\vect{\xi}} \\
    &= \delby{x^{i}}{\xi^{d}}\delby{\xi^{e}}{x^{j}}\delby{\xi^{d}} 
    {\nu^{a}}\delby{\nu^{b}}{\xi^{e}}\fnof{{\tilde{\sigma}}^{a}_{.b}}{\vect{\xi}}
  \end{split}
\end{equation}
where $\tilde{\tensor{\sigma}}$ is interpolated in the normal way \ie
\begin{equation}
  \fnof{\tilde{\tensor{\sigma}}}{\vect{\xi}}
  =\gbfn{p}{\delta}{\vect{\xi}}\nodedof{\tilde{\tensor{\sigma}}}{p}{\delta}
  \gsf{p}{\delta}
\end{equation}

Using an interpolated variables yields
\begin{multline}
  \dsum_{e=1}^{E}\dintl{\vect{0}}{\vect{1}}G^{jk}\delby{x^{i}}{\xi^{d}}
    \delby{\xi^{e}}{x^{j}}\delby{\xi^{d}}{\nu^{a}}
    \delby{\nu^{b}}{\xi^{e}}\fnof{{\tilde{\sigma}}^{a}_{.b}}{\vect{\xi}}\delby{\xi^{s}}{x^{i}} \\
    \delby{\pbrac{\gbfn{n}{\beta}{\vect{\xi}}\nodedof{u}{n}{\beta}\gsf{n}{\beta}}}{\xi^{s}}
    \delby{\xi^{r}}{x^{k}}\delby{\pbrac{\gbfn{m}{\alpha}{\vect{\xi}}\gsf{m}{\alpha}}}{\xi^{r}}
    \abs{\fnof{\matr{J}}{\vect{\xi}}}d\vect{\xi} \\ 
  = \dsum_{f=1}^{F}\gint{\Gamma_{f}}{}{\gbfn{o}{\gamma}{\vect{\xi}}\nodedof{q}{o}{\gamma}
    \gsf{o}{\gamma}\gbfn{m}{\alpha}{\vect{\xi}}\gsf{m}{\alpha}}{\Gamma}
\end{multline}
where $\fnof{\matr{J}}{\vect{\xi}}$ is the \emph{Jacobian} of the
transformation from the integration $\vect{x}$ to $\vect{\xi}$ coordinates.

Taking the fixed nodal degrees-of-freedom and scale factors outside the integral we have
\begin{multline}
  \dsum_{e=1}^{E}\nodedof{u}{n}{\beta}\gsf{m}{\alpha}\gsf{n}{\beta}
  \dintl{\vect{0}}{\vect{1}}G^{jk}\delby{x^{i}}{\xi^{d}}
  \delby{\xi^{e}}{x^{j}}\delby{\xi^{d}}{\nu^{a}}
  \delby{\nu^{b}}{\xi^{e}}\fnof{{\tilde{\sigma}}^{a}_{.b}}{\vect{\xi}} \\
  \delby{\xi^{r}}{x^{i}}\delby{\xi^{s}}{x^{k}}
  \delby{\gbfn{m}{\alpha}{\vect{\xi}}}{\xi^{s}}
  \delby{\gbfn{n}{\beta}{\vect{\xi}}}{\xi^{r}}
  \abs{\fnof{\matr{J}}{\vect{\xi}}}d\vect{\xi} \\
  = \dsum_{f=1}^{F}\nodedof{q}{o}{\gamma}\gsf{m}{\alpha}\gsf{o}{\gamma}
  \gint{\Gamma_{f}}{}{\gbfn{o}{\gamma}{\vect{\xi}}\gbfn{m}{\alpha}{\vect{\xi}}}{\Gamma}
  \label{eqn:elementalfemlhs1}
\end{multline}

This is an equation of the form of
\begin{equation}
  \matr{K}\vect{u}=\vect{f}
\end{equation}
where
\begin{equation}
  \vect{f}=\matr{N}\vect{q}
\end{equation}

The elemental stiffness matrix, $K^{\alpha\beta}_{mn}$, is given by
\begin{equation}
  K^{\alpha\beta}_{mn}=\gsf{m}{\alpha}\gsf{m}{\beta}
  \gint{\vect{0}}{\vect{1}}{\delby{\gbfn{m}{\alpha}{\vect{\xi}}}{\xi^{r}}
    \delby{\gbfn{n}{\beta}{\vect{\xi}}}{\xi^{s}}\fnof{\gamma^{rs}}{\vect{\xi}}
    \abs{\fnof{\matr{J}}{\vect{\xi}}}}{\vect{\xi}}
  \label{eqn:elementalfemlhs2}
\end{equation}
where
\begin{equation}
  \fnof{\gamma^{rs}}{\vect{\xi}}=G^{jk}\delby{x^{i}}{\xi^{d}}
  \delby{\xi^{e}}{x^{j}}\delby{\xi^{d}}{\nu^{a}}\delby{\nu^{b}}{\xi^{e}}
  \fnof{{\tilde{\sigma}}^{a}_{.b}}{\vect{\xi}}\delby{\xi^{r}}{x^{i}}\delby{\xi^{s}}{x^{k}}
  \label{eqn:diffusiongammadefinition1}
\end{equation}

Note that for Laplace's equation with no conductivity or fibre fields we have
\begin{equation}
  \fnof{\gamma^{rs}}{\vect{\xi}}=G^{ik}\delby{\xi^{r}}{x^{i}}\delby{\xi^{s}}{x^{k}}
  \label{eqn:diffusiongammadefinition2}
\end{equation}
and that for rectangular-Cartesian coordinates systems
$G^{ik}=\contrakronecker{i}{k}$ and thus $i=k$. This now gives
\begin{equation}
  \fnof{\gamma^{rs}}{\vect{\xi}}=\delby{\xi^{r}}{x^{i}}\delby{\xi^{s}}{x^{i}}=g^{rs}
  \label{eqn:diffusiongammadefinition3}
\end{equation}
where $g^{rs}$ is the \emph{contravariant metric tensor} from $\vect{x}$ to
$\vect{\xi}$ coordinates. It may thus be helpful to think about $\gamma^{rs}$
as a scaled/transformed contravariant metric tensor.

The right hand side flux matrix, $N^{\alpha\gamma}_{mo}$, is given by
\begin{equation}
  N^{\alpha\gamma}_{mo} = \gsf{m}{\alpha}\gsf{o}{\gamma}
  \gint{\Gamma_{f}}{}{\gbfn{m}{\alpha}{\vect{\xi}}\gbfn{o}{\gamma}{\vect{\xi}}}{\Gamma}
\end{equation}




